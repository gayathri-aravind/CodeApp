<?php
// SITE URL: http://codeapp-local:8081/index.php/
defined('BASEPATH') OR exit('No direct script access allowed');

use MiladRahimi\PhpCrypt\Symmetric;
use PHPMailer\PHPMailer\PHPMailer;

require_once(APPPATH.'libraries/miladrahimi/phpcrypt/src/Symmetric.php');


class User extends CI_Controller {

	public function __construct() {

        parent::__construct();
		$this->load->helper('url', 'form');
        $this->load->library('session');
		$this->load->model('UsersModel');
    }

	public function index()
	{
		$this->load->view('user');
	}

	
	public function create(){
		/*
			Store the data in a MySQL DB table in an encrypted format. 
			Use the library miladrahimi/phpcrypt for encryption
			The encryption key should be autogenerated while saving the record
			DB table should contain the encrypted data and record id only. The encryption key should not be saved.
			After successful submission, the record id and encryption key should be displayed to the user
		*/
		// Get the form data
		$user_input=addslashes($this->input->post('user_input'));
		$user_email=addslashes($this->input->post('user_email'));

		// Generate a random encryption key and encrypt the user_input with that key
		$key = Symmetric::generateKey();
		$symmetric = new Symmetric($key);
		$encryptedData = $symmetric->encrypt($user_input);

		// Inserting the recordID and encryptedData into the "MyCstomText" table
		$insertId = $this->UsersModel->insertUserdata($encryptedData, $user_email);
		if($insertId){
			$data['userData'] = array('record_id' => $insertId, 'encryption_key' => $key, 'msg' => 'success');

			/*
				After successful submission, the key should be mailed to the user(get user email as one of the input) via PHPmailer & mailtrap
				Create another page
				to take the record Id and encryption key as input
				Upon submitting, search & retrieve the record from the DB table
				Decrypt the data and display it back to the user
			*/

			// Get user email from the database and pass it to the PHPMailer
			$user_data = $this->UsersModel->getUserData($insertId);

			//$this->load->library('email');
			$emailResult = $this->send($user_data[0]->email, $key);
			$emailResult = 1; // Hardcoded
			// If email send successfully, redirect to another page to show the decrypted text
			if($emailResult){
				$sessionUserData = array(
					'record_id'  => $insertId,
					'encryption_key'     => $key
				);
				$this->session->set_userdata($sessionUserData);
				$data['userData']['searchLink'] = "<a href=\"http://codeapp-local:8081/index.php/User/getDecyptedInput\">Link</a>";
			}else{
				$data['userData']['searchLink'] = "";
			}
		}else{
			$data['userData'] = array('msg' => 'error');
		}
		$this->load->view('users_create',$data);
	}

	public function send($userEmail, $encryptionKey){
		// Load PHPMailer library
		$this->load->library('phpmailer_lib');

		// PHPMailer object
		$mail = $this->phpmailer_lib->load();

		// SMTP configuration
		$my_config = $this->config->load('email', true); // Loading the email config file
		// var_dump($my_config); // bool(true)
		$email_settings = $this->config->item('email_settings', 'email'); // Getting the value of $config['email_settings] from 'email' config file
		/*
		var_dump($email_settings);
		array(7) { ["protocol"]=> string(4) "smtp" ["smtp_host"]=> string(24) "sandbox.smtp.mailtrap.io" ["smtp_port"]=> int(2525) ["smtp_user"]=> string(14) "25bb92a8501a93" ["smtp_pass"]=> string(14) "100d0893f1d321" ["crlf"]=> string(2) " " ["newline"]=> string(2) " " }
		*/
		// echo '<pre>';
		// print_r($email_settings);
		// exit;
		$mail->isSMTP();
		$mail->Host     = $email_settings['smtp_host'];
		$mail->SMTPAuth = true;
		$mail->Username = $email_settings['smtp_user'];
		$mail->Password = $email_settings['smtp_pass'];
		$mail->SMTPSecure = 'ssl';
		$mail->Port     = $email_settings['smtp_port'];

		// $mail->setFrom('info@inbox.mailtrap.io');
		$mail->setFrom('info@ziffity.com', 'Mailtrap');

		// Add a recipient
		$mail->addAddress($userEmail);

		// Email subject
		$mail->Subject = 'Your Encryption key';
		$mail->isHTML(true);

		$mail->SMTPOptions = array(
			'ssl' => array(
			'verify_peer' => false,
			'verify_peer_name' => false,
			'allow_self_signed' => true
			)
		);
		
		// Email body content
		$mailContent = "<h1>Encryption key of yours</h1>
			<p>This is your encryption key:".$encryptionKey." </p>";
		$mail->Body = $mailContent;
			// echo '<pre>';print_r($mail);
		// Send email
		if(!$mail->send()){
			// echo 'Email not send successfully';
			return 0;
		}else{
			// echo 'Email send successfully';
			return 1;
		}
		// return 1;
	}

	public function getDecyptedInput(){
		// print_r($_SESSION);
		$record_id=$this->session->userdata('record_id');
		$encryption_key=$this->session->userdata('encryption_key');

		if(isset($record_id) && isset($encryption_key)){

			$symmetric = new Symmetric($encryption_key);

			// Get encryptedData for the corresponding encryption key
			$userData = $this->UsersModel->getUserData($record_id);

			// echo 'ET:'.$userData[0]->encryptedText.'<br>';

			$decryptedText = $symmetric->decrypt($userData[0]->encryptedText); 
			
			$data['userData'] = array('record_id' => $record_id, 'encryption_key' => $encryption_key, 'decryptedText' => $decryptedText);

			$this->load->view('usersearch', $data);

		}
	}
}
